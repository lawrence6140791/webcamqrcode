<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¬ç”¨ QR Code æƒæå™¨</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h2 { margin-bottom: 10px; color: #333; }
        
        /* éŸ¿æ‡‰å¼æƒææ¡†ï¼šæ‰‹æ©Ÿå¯¬åº¦ 100%ï¼Œé›»è…¦å›ºå®šå¯¬åº¦ */
        #reader {
            width: 100%;
            max-width: 500px; 
            background: #000;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            width: 100%;
            max-width: 500px;
            min-height: 50px;
            word-break: break-all;
            display: none; /* é è¨­éš±è— */
        }

        .btn-group { margin-top: 20px; }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: white;
            transition: opacity 0.3s;
        }

        #start-btn { background-color: #007aff; }
        #stop-btn { background-color: #ff3b30; display: none; }
        
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #error-msg { color: #e74c3c; margin-top: 10px; text-align: center; font-size: 14px;}
    </style>
</head>
<body>

    <h2>QR Code æƒæå™¨</h2>
    
    <div id="reader"></div>
    
    <div class="btn-group">
        <button id="start-btn" onclick="startScanner()">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ</button>
        <button id="stop-btn" onclick="stopScanner()">â›” åœæ­¢æƒæ</button>
    </div>

    <div id="result"></div>
    <div id="error-msg"></div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error-msg');

        // æƒææˆåŠŸçš„å›èª¿
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`æƒæçµæœ: ${decodedText}`);
            
            resultDiv.style.display = "block";
            resultDiv.innerHTML = `âœ… <b>æƒææˆåŠŸï¼š</b><br>${decodedText}`;
            
            // æˆåŠŸå¾Œæ˜¯å¦è¦åœæ­¢ï¼Ÿå¦‚æœä¸åœæ­¢ï¼Œè«‹è¨»è§£æ‰ä¸‹é¢é€™è¡Œ
            // stopScanner();
        }

        // æ ¸å¿ƒå•Ÿå‹•é‚è¼¯
        async function startScanner() {
            // é‡ç½®ä»‹é¢
            errorDiv.innerText = "";
            resultDiv.style.display = "none";
            startBtn.disabled = true;
            startBtn.innerText = "å•Ÿå‹•ä¸­...";

            try {
                // 1. å…ˆç²å–æ‰€æœ‰é¡é ­åˆ—è¡¨
                const devices = await Html5Qrcode.getCameras();
                
                if (devices && devices.length) {
                    let cameraId;
                    
                    // 2. æ™ºèƒ½åˆ¤æ–·ï¼š
                    // å¦‚æœæœ‰å¤šå€‹é¡é ­ï¼ˆæ‰‹æ©Ÿï¼‰ï¼Œå˜—è©¦æ‰¾ "back" æˆ– "environment" çš„é¡é ­
                    // å¦‚æœåªæœ‰ä¸€å€‹é¡é ­ï¼ˆç­†é›»ï¼‰ï¼Œç›´æ¥ç”¨ç¬¬ä¸€å€‹
                    if (devices.length > 1) {
                        // å˜—è©¦å°‹æ‰¾å¾Œç½®é¡é ­
                        const backCamera = devices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('environment'));
                        
                        // æ‰¾åˆ°äº†å°±ç”¨å¾Œç½®ï¼Œæ²’æ‰¾åˆ°å°±ç”¨åˆ—è¡¨æœ€å¾Œä¸€å€‹ï¼ˆé€šå¸¸æ˜¯å¾Œç½®ï¼‰
                        cameraId = backCamera ? backCamera.id : devices[devices.length - 1].id;
                    } else {
                        // åªæœ‰ä¸€å€‹é¡é ­ (ç­†é›»)
                        cameraId = devices[0].id;
                    }

                    // 3. å•Ÿå‹•æƒæ
                    await html5QrCode.start(
                        cameraId, 
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        onScanSuccess
                    );

                    // ä»‹é¢æ›´æ–°
                    startBtn.style.display = "none";
                    stopBtn.style.display = "inline-block";
                    startBtn.innerText = "ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ"; // å¾©åŸæ–‡å­—
                    startBtn.disabled = false;

                } else {
                    throw "æ‰¾ä¸åˆ°æ”åƒé ­è¨­å‚™";
                }
            } catch (err) {
                console.error(err);
                startBtn.disabled = false;
                startBtn.innerText = "ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ";
                errorDiv.innerText = `ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ${err}`;
                if (err.toString().includes("Permission")) {
                    errorDiv.innerText += " (è«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼Œä¸”ç¶²å€ç‚º HTTPS)";
                }
            }
        }

        // åœæ­¢é‚è¼¯
        function stopScanner() {
            html5QrCode.stop().then(() => {
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                resultDiv.innerHTML += "<br>(å·²åœæ­¢)";
            }).catch(err => {
                console.log("åœæ­¢å¤±æ•—", err);
            });
        }
    </script>
</body>
</html>